# 项目问题修复总结报告

本文件总结了 `SaleSystem` 项目中遇到的关键问题、产生原因以及具体的修复方案。

## 1. 致命错误：数据文件每次运行都被清空

### 🔴 问题描述
每次运行程序并关闭后，`stack.txt` 中的内容都会全部丢失，变成空白或只剩表头。

### 🔍 根本原因
代码逻辑存在致命闭环：
1.  **读取被禁用**：在 `CInfoFile` 的构造函数中，读取数据的代码 `// ReadDocLine();` 被注释掉了。导致程序启动时，内存中的商品列表 `ls` 是空的。
2.  **强制写入**：在析构函数 `~CInfoFile()` 中，强制调用了 `WriteDocLine()`。
3.  **结果**：程序关闭时，将内存中空的列表写入文件，直接覆盖了原有的数据。

### ✅ 修复方案
*   **启用读取**：取消构造函数中 `ReadDocLine()` 的注释。
*   **增加保护**：在 `WriteDocLine()` 中增加判断，如果内存列表为空但文件本身有内容，则拒绝写入，防止意外清空。

---

## 2. 解析错误：无法读取带空格的商品名

### 🔴 问题描述
如果商品名称中包含空格（如 `Apple iPhone 14`），程序读取会出错，导致后续字段（价格、库存）错位或读取失败。

### 🔍 根本原因
使用了 C++ 流提取运算符 `>>` 进行读取：
```cpp
file >> data.id >> ... >> data.name ...
```
`>>` 运算符默认以空格为分隔符，遇到空格就会停止读取当前字段。

### ✅ 修复方案
改用 `getline` 读取整行，然后手动查找分隔符 `|` 进行分割。这使得程序能够正确处理包含空格的字符串。

---

## 3. 编译错误：C++ 版本与类型不兼容

### 🔴 问题描述
Visual Studio 报错：
*   `意外的类型 auto`
*   `std::vector` 与 `std::list` 不匹配
*   `iostream.h` 未找到

### 🔍 根本原因
1.  **旧标准**：项目似乎配置为较旧的 C++ 标准（不支持 C++11 的 `auto` 和范围 `for` 循环）。
2.  **类型混用**：`CSellDlg` 中使用了 `list<msg>::iterator`，但头文件中可能定义为了 `vector`。

### ✅ 修复方案
*   **移除 auto**：将所有 `auto` 遍历改为传统的迭代器写法：
    ```cpp
    for (list<msg>::iterator it = ls.begin(); it != ls.end(); it++)
    ```
*   **统一容器**：确保 `CInfoFile.h` 中定义的是 `std::list<msg> ls;`。

---

## 4. 编码错误：常量中有换行符 (C2001)

### 🔴 问题描述
报错 `error C2001: 常量中有换行符`，且界面或文件中中文显示乱码。

### 🔍 根本原因
源代码文件的编码格式（通常是 UTF-8 无 BOM）与 Visual Studio 默认的编译器设置（GB2312/ANSI）冲突。编译器将中文字节误读为引号结束符或换行符。

### ✅ 修复方案
*   **修改表头**：将写入文件的中文表头 `"商品ID|..."` 改为英文 `"ID|Name..."`，彻底规避编码问题。
*   **重写文件**：重新保存源代码文件，确保格式正确。

---

## 5. 功能缺失：选中商品不更新价格

### 🔴 问题描述
在销售界面下拉框选择商品后，下方的“单价”和“库存”显示为 0 或不变化。

### 🔍 根本原因
`CSellDlg.cpp` 中的消息映射 `ON_CBN_SELCHANGE` 被注释掉，且对应的事件处理函数 `OnCbnSelchangeCombo2` 逻辑缺失或未启用。

### ✅ 修复方案
*   **恢复消息映射**：取消 `ON_CBN_SELCHANGE` 的注释。
*   **实现逻辑**：完善 `OnCbnSelchangeCombo2` 函数，使其根据选中的商品名在列表中查找对应的价格和库存，并调用 `UpdateData(FALSE)` 刷新界面。

---

## 📝 总结
经过以上修复，项目现在可以：
1.  **正常编译**（无报错）。
2.  **持久化数据**（重启程序数据不丢失）。
3.  **正确交互**（选择商品自动更新信息）。
